# Директивы по доступу к API Публичной Кадастровой Карты (ПКК)

Дата последнего обновления: 2025-05-14

## 1. Обзор и предварительные выводы (PREP-1)

В ходе исследования были проанализированы методы доступа к данным Публичной кадастровой карты (`pkk.rosreestr.ru`). Основное внимание уделялось эндпоинтам, используемым веб-интерфейсом портала.

**Ключевые выводы:**

*   Портал использует два основных типа API для получения данных:
    1.  REST API для поиска и получения детальной информации об объектах (далее "Feature API").
    2.  API на базе ArcGIS Server для получения наборов объектов в заданной географической области (далее "ArcGIS API").
*   Явная аутентификация (API-ключи, токены) для базовых запросов на момент исследования **не требовалась**.
*   **Проблема:** Начиная с определенного момента (примерно 14.05.2025), прямые запросы к обоим типам API с использованием стандартных HTTP-клиентов (например, `requests` в Python) стали возвращать HTML-страницу вместо ожидаемого JSON. Это свидетельствует о внедрении мер защиты от автоматизированных запросов (например, проверка сессии, JavaScript-вызовы, CAPTCHA, блокировка по User-Agent или IP).

## 2. Анализ сетевого трафика и эндпоинты

Анализ проводился с использованием инструментов разработчика в браузере при взаимодействии с `pkk.rosreestr.ru`.

### 2.1. Feature API (`https://pkk.rosreestr.ru/api/features/...`)

Используется для поиска объектов по кадастровому номеру или адресу и получения их детальной атрибутивной информации, включая геометрию.

*   **Эндпоинт для поиска объектов:**
    *   URL: `https://pkk.rosreestr.ru/api/features/<layer_type>`
    *   Метод: `GET`
    *   Основные параметры:
        *   `text`: Кадастровый номер или адрес (например, `50:23:0040803:335`).
        *   `tolerance`: Допуск (например, `1`).
        *   `limit`: Количество возвращаемых результатов (например, `11`).
    *   Пример: `https://pkk.rosreestr.ru/api/features/1?text=50:23:0040803:335&tolerance=1&limit=11` (для слоя участков).
    *   Ожидаемый ответ: JSON со списком найденных объектов. Каждый объект содержит `attrs.id`, используемый для получения детальной информации.

*   **Эндпоинт для получения детальной информации об объекте:**
    *   URL: `https://pkk.rosreestr.ru/api/features/<layer_type>/<object_id>`
    *   Метод: `GET`
    *   `<layer_type>`: Идентификатор слоя (см. п. 2.3).
    *   `<object_id>`: ID объекта из ответа на поисковый запрос.
    *   Пример: `https://pkk.rosreestr.ru/api/features/1/ID_ОБЪЕКТА`.
    *   Ожидаемый ответ: JSON с подробной информацией об объекте, включая `feature.attrs` (атрибуты) и `feature.geometry` (координаты).

### 2.2. ArcGIS API (`https://pkk.rosreestr.ru/arcgis/rest/services/PKK6/CadastreSelected/MapServer/...`)

Используется для получения наборов объектов (включая их геометрии и атрибуты) в определенной географической области (bounding box).

*   **Эндпоинт для запроса объектов слоя:**
    *   URL: `https://pkk.rosreestr.ru/arcgis/rest/services/PKK6/CadastreSelected/MapServer/<layer_id>/query`
    *   Метод: `GET` или `POST` (POST предпочтительнее при большом количестве параметров или сложной геометрии).
    *   Основные параметры:
        *   `f`: Формат ответа (обычно `json`).
        *   `returnGeometry`: `true` (для получения геометрии) или `false`.
        *   `spatialRel`: Тип пространственного отношения (например, `esriSpatialRelIntersects` для пересечения).
        *   `geometry`: JSON-строка, описывающая геометрию для пространственного фильтра (см. п. 3.1).
        *   `geometryType`: Тип геометрии (например, `esriGeometryEnvelope` для bounding box).
        *   `inSR`: Система координат входной геометрии (например, `102100`).
        *   `outSR`: Система координат выходной геометрии (например, `102100`).
        *   `outFields`: Список запрашиваемых атрибутивных полей (например, `*` для всех полей).
        *   `resultOffset`, `resultRecordCount`: Для пагинации результатов.
    *   Пример (для слоя участков `21`): `https://pkk.rosreestr.ru/arcgis/rest/services/PKK6/CadastreSelected/MapServer/21/query`.
    *   Ожидаемый ответ: JSON, содержащий массив `features`, где каждый элемент — объект с полями `attributes` и `geometry`.

### 2.3. Идентификаторы слоев (Layer IDs)

*   **Для Feature API (`<layer_type>`):**
    *   `1`: Земельные участки (ЗУ)
    *   `5`: Объекты капитального строительства (ОКС)
    *   `7`: Зоны с особыми условиями использования территорий (ЗОУИТ)
    *   (и другие, список не исчерпывающий)

*   **Для ArcGIS API (`<layer_id>` в `CadastreSelected/MapServer/<layer_id>/query`):**
    *   `21`: Земельные участки (полигоны)
    *   `22`: Земельные участки (центроиды)
    *   `23`: ОКС (полигоны)
    *   `24`: ОКС (центроиды)
    *   `27`: Кадастровые кварталы
    *   `28`: Кадастровые районы
    *   `29`: Кадастровые округа
    *   (и другие)

## 3. Методы запросов и параметры (PREP-3, FR-8)

### 3.1. Запрос по географической области (Bounding Box) (FR-8)

Выполняется через ArcGIS API.
*   **`geometryType`**: `esriGeometryEnvelope`
*   **`geometry`** (JSON-строка):
    ```json
    {
      "xmin": <min_longitude_or_x>,
      "ymin": <min_latitude_or_y>,
      "xmax": <max_longitude_or_x>,
      "ymax": <max_latitude_or_y>,
      "spatialReference": { "wkid": 102100 } // Web Mercator
    }
    ```
*   **`spatialRel`**: `esriSpatialRelIntersects` (наиболее частый случай)
*   **Система координат**: `102100` (Web Mercator) для `inSR`, `outSR` и `spatialReference.wkid`.

### 3.2. Аутентификация

На момент первоначального исследования (до ~14.05.2025) явная аутентификация не требовалась. Однако последующие тесты показали, что доступ усложнен (см. п. 4.2).

## 4. Прототипирование и результаты (PREP-2, PREP-4, PREP-5)

### 4.1. Разработанные скрипты-прототипы

Были созданы два Python-скрипта с использованием библиотеки `requests`:

1.  `scripts/test_search_by_cadnum.py`: 
    *   Цель: поиск объекта по кадастровому номеру и получение его деталей через Feature API.
    *   [Ссылка на скрипт](mdc:scripts/test_search_by_cadnum.py)
2.  `scripts/test_get_features_in_bbox.py`: 
    *   Цель: получение объектов в заданной прямоугольной области через ArcGIS API.
    *   [Ссылка на скрипт](mdc:scripts/test_get_features_in_bbox.py)

Пример вызова для `test_search_by_cadnum.py`:
```python
# python scripts/test_search_by_cadnum.py
# (внутри скрипта используется пример кадастрового номера)
```

Пример вызова для `test_get_features_in_bbox.py`:
```python
# python scripts/test_get_features_in_bbox.py
# (внутри скрипта используются примерные координаты BBOX)
```

### 4.2. Результаты тестирования прототипов

*   **Исходная проблема**: Ошибка `SSL: CERTIFICATE_VERIFY_FAILED`. Была временно решена добавлением `verify=False` в вызовы `requests`.
*   **Основная проблема**: После обхода SSL-ошибки оба скрипта начали получать **HTML-страницу вместо JSON** от всех эндпоинтов (`pkk.rosreestr.ru/api/features/...` и `pkk.rosreestr.ru/arcgis/.../query`). Это указывает на наличие защитных механизмов на стороне сервера, которые не позволяют прямые запросы без корректной браузерной сессии или специальных токенов/заголовков.

### 4.3. Пример ожидаемого JSON-ответа (фрагмент для `/api/features/1/<id>`)

```json
// Этот пример основан на структуре, наблюдавшейся до возникновения проблем с доступом
{
  "feature": {
    "attrs": {
      "id": "ID_ОБЪЕКТА",
      "cn": "50:23:0040803:335",
      "address": "Российская Федерация, Московская область, ...",
      "area_value": 1200,
      "area_unit": "055", // кв. м
      "category_type": "003002000000", // Земли населенных пунктов
      "util_code": "130030100000",
      "util_by_doc": "Для индивидуального жилищного строительства",
      // ... другие атрибуты
    },
    "geometry": {
      "type": "Polygon", // или MultiPolygon
      "coordinates": [[[ [x1,y1],[x2,y2], ... ]]]
    }
    // ... другая информация
  }
}
```

## 5. Рекомендации и следующие шаги (PREP-5)

1.  **Необходим углубленный анализ**: Требуется изучить JavaScript-код портала `pkk.rosreestr.ru` для понимания, как формируются корректные запросы в браузере (какие заголовки, cookies, токены используются, есть ли обфускация или вызовы challenge-response).
2.  **Рассмотреть альтернативные инструменты**: Если простой анализ не даст результатов, необходимо рассмотреть использование headless-браузеров (например, `Selenium`, `Playwright`) для имитации полного взаимодействия с сайтом. Это значительно усложнит процесс извлечения данных, но может быть единственным рабочим вариантом.
3.  **Мониторинг изменений**: API является недокументированным и может изменяться без предупреждения. Любое решение должно учитывать эту нестабильность.
4.  **Поиск альтернативных источников/библиотек**: Исследовать, существуют ли сторонние библиотеки или сервисы, которые уже решили проблему доступа к данным ПКК (хотя это маловероятно для актуальных и бесплатных решений из-за динамики изменений на портале).

**В связи с текущими проблемами доступа, реализация функциональных требований FR-8 и FR-9 с использованием прямых HTTP-запросов невозможна без преодоления описанных выше блокировок.** 